# 📈 生理数据波形图使用指南

## 🎯 功能说明

在WaveMonitor中实时显示心率（HR）和呼吸率（RR）波形图，支持历史数据回放和实时监测。

---

## 📊 波形显示

### 界面布局

```
WaveMonitor (620x650)
┌────────────────────────┐
│ [控制栏：3行 ~120px]    │
├────────────────────────┤
│ HR (bpm)   ┌─────────┐ │ ← 心率波形 (~240px)
│            │~~~~~~~~~│ │
│            └─────────┘ │
├────────────────────────┤
│ RR (/min)  ┌─────────┐ │ ← 呼吸率波形 (~240px)
│            │~~~~~~~~~│ │
│            └─────────┘ │
└────────────────────────┘
```

### Y轴范围

**固定范围：** 0 - 150

**刻度显示：** 0, 50, 100, 150

---

## 🎨 波形样式

### 背景颜色（可切换）

**白色背景：**
- HR Normal: 黑色 `#000000`
- RR Normal: 绿色 `#00b050`

**黑色背景：**
- HR Normal: 白色 `#ffffff`
- RR Normal: 绿色 `#00b050`

**L2 & L1（两种背景相同）：**
- L2: 黄色 `#ffc000`
- L1: 红色 `#ff4d4f`

### 辅助线

**Normal边界（黄色虚线）：**
- HR: y=55, y=95
- RR: y=10, y=23

**L2边界（红色虚线）：**
- HR: y=45, y=54, y=96, y=115
- RR: y=8, y=9, y=24, y=26

---

## 📐 X轴计算

### 固定长度平分

**Canvas宽度：** 560px（留40px给Y轴刻度）

**X坐标计算：**
```typescript
xStep = 520 / dataPoints  // 平分Canvas宽度
x = index * xStep + 40    // 40px是Y轴刻度区
```

**示例：**
- 2分钟 = 120个点 → 每点 4.3px
- 5分钟 = 150个点（2秒1笔）→ 每点 3.5px
- 30分钟 = 900个点（2秒1笔）→ 每点 0.6px

---

## 🎬 使用方式

### 1. Demo模式

```
1. 点击 Demo 按钮
2. 系统自动：
   - 生成2分钟仿真数据（包含HR/RR）
   - 一次性加载所有生理数据
   - 绘制完整波形曲线
3. 播放期间：
   - 雷达数据逐帧播放
   - 波形曲线保持完整显示
```

### 2. fromServer模式

```
1. 输入 DeviceID + 时间
2. 点击 Play
3. 系统自动：
   - 从服务器查询历史数据
   - 提取HR/RR数据
   - 绘制完整波形
```

### 3. fromFile模式

```
1. 选择本地JSON文件
2. 点击 Play
3. 系统自动：
   - 解析文件数据
   - 提取HR/RR数据
   - 绘制完整波形
```

---

## 🔄 数据处理流程

### 历史数据加载

```
historicalData = [
  {
    timestamp: 1699000000,
    persons: [{
      heartRate: 72,
      breathRate: 16,
      ...
    }]
  },
  ...
]
    ↓
提取生理数据
    ↓
vitalDataCache = [
  { timestamp: 1699000000, heartRate: 72, breathing: 16 },
  { timestamp: 1699000001, heartRate: 73, breathing: 16 },
  ...
]
    ↓
绘制波形（一次性）
```

### 点击新Play

```
点击Play
    ↓
清空vitalDataCache
    ↓
加载新数据
    ↓
提取生理数据
    ↓
绘制新波形
```

---

## 🎨 视觉效果

### 正常睡眠（HR: 70, RR: 14）

```
HR波形：黑色/白色（Normal区间）
RR波形：绿色（Normal区间）
辅助线：黄色虚线标示Normal边界
```

### 跌倒应激（HR: 110, RR: 26）

```
HR波形：黄色（L2区间）
RR波形：黄色（L2区间）
辅助线：红色虚线标示L2边界
```

### 严重异常（HR: 120, RR: 30）

```
HR波形：红色（L1区间）
RR波形：红色（L1区间）
```

---

## 📊 Demo数据特点

### 0-60秒（床上场景）

**生理数据变化：**
```
深度睡眠：HR 50-65, RR 10-14
浅睡眠：  HR 60-75, RR 12-18
清醒：    HR 70-85, RR 14-20
坐起床：  HR 75-90, RR 16-22
```

### 60-120秒（床下场景）

**生理数据变化：**
```
正常活动：HR 70-95, RR 14-20
跌倒应激：HR 105-120 (L1), RR 24-28 (L2-L1)
```

**波形特征：**
- 前60秒：平稳波动（Normal区间）
- 跌倒时：突然升高（进入L2/L1区间）
- 颜色变化：黑/绿 → 黄 → 红

---

## 🎛️ 控制选项

### Dark背景切换

**位置：** 控制栏第3行最右侧

**功能：**
- ☐ Dark - 白色背景（HR黑色，RR绿色）
- ☑ Dark - 黑色背景（HR白色，RR绿色）

**快捷键：** 无（点击checkbox切换）

---

## 📋 数据要求

### 输入数据格式

```json
[
  {
    "timestamp": 1699000000,
    "persons": [{
      "heartRate": 72,       // 必需（0-150）
      "breathRate": 16,      // 必需（0-150）
      "sleepState": 1,       // 可选
      ...
    }]
  }
]
```

### 字段说明

- `heartRate`: 心率（次/分钟），范围 0-150
- `breathRate`: 呼吸率（次/分钟），范围 0-150
- `sleepState`: 睡眠状态（可选）

### 异常值处理

以下值会被忽略（不绘制）：
- `null`
- `undefined`
- `0`
- `-255`

---

## 🔧 技术实现

### Canvas配置

```typescript
CANVAS_WIDTH = 560   // 画布宽度
CANVAS_HEIGHT = 240  // 每个波形高度
Y_MIN = 0
Y_MAX = 150
```

### 颜色映射

```typescript
// HR Normal
darkBg ? '#ffffff' : '#000000'

// RR Normal
'#00b050'

// L2
'#ffc000'

// L1
'#ff4d4f'
```

### 绘制顺序

1. 清空画布（黑/白背景）
2. 绘制辅助线（黄色虚线 = Normal边界）
3. 绘制L2边界（红色虚线）
4. 绘制Y轴刻度和网格线
5. 绘制波形曲线（逐段连线，颜色随数值变化）

---

## ✅ 功能特点

- ✅ **一次性加载**：历史数据load后立即绘制完整曲线
- ✅ **自动更新**：点击新Play，自动清空旧数据，绘制新曲线
- ✅ **背景切换**：黑/白背景适应不同场景
- ✅ **分级显示**：Normal/L2/L1自动变色
- ✅ **X轴自适应**：根据数据点数自动平分
- ✅ **数据来源透明**：不关心数据来自Server/File/Demo

---

## 🎯 典型场景

### 场景1：查看2分钟Demo

```
操作：点击 Demo
效果：
- 生成120个数据点
- HR: 床上平稳（55-85），床下波动（70-95），跌倒升高（105-120）
- RR: 床上平稳（10-18），床下波动（14-20），跌倒升高（24-28）
- 波形颜色：绿/黑 → 黄 → 红
```

### 场景2：查看30分钟历史

```
操作：
1. 输入 DeviceID + 时间
2. 点击 Play

效果：
- 加载900个数据点（2秒1笔）
- 完整曲线一次性绘制
- X轴自动压缩（每点0.6px）
```

---

## 🐛 常见问题

### Q: 波形不显示？

**A:** 检查：
1. 数据是否包含heartRate/breathRate字段
2. Canvas是否初始化（查看控制台）
3. vitalDataCache是否有数据

### Q: 颜色不对？

**A:** 检查阈值配置：
- Normal: HR [55-95], RR [10-23]
- L2: HR [45-54,96-115], RR [8-9,24-26]
- L1: 其他所有值

### Q: 波形太密/太稀？

**A:** X轴自动平分，取决于数据点数：
- 少于200点：清晰可见
- 200-500点：较密集
- 500+点：很密集（考虑降采样）

---

## 📚 相关文档

- [生理指标分级标准](./VITAL_SIGNS_STANDARDS.md)
- [WaveMonitor布局设计](./src/components/WAVE_MONITOR_3ROW_LAYOUT.md)
- [API集成文档](./API_INTEGRATION.md)

---

**现在可以在WaveMonitor中实时查看心率和呼吸率波形了！** 📈


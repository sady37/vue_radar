# é›·è¾¾é…ç½® MQTT å‘½ä»¤æ ¼å¼ç¤ºä¾‹

## æ¦‚è¿°

é›·è¾¾è®¾å¤‡é€šè¿‡ MQTT è¿›è¡Œé…ç½®ï¼Œä½¿ç”¨æ ‡å‡†çš„ key/value æ ¼å¼ã€‚æœ¬æ–‡æ¡£å±•ç¤ºäº†å„ç§é…ç½®åœºæ™¯ä¸‹ç”Ÿæˆçš„ MQTT å‘½ä»¤ã€‚

## MQTT ä¸»é¢˜

- **è®¾ç½®/è¯»å–**: `prop/{productId}/{deviceId}/get`
- **è¿”å›**: `prop/{productId}/{deviceId}/post`

## å‘½ä»¤æ ¼å¼

### è®¾ç½®å±æ€§ (update)

```json
{
  "cmd": "update",
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "key1": "value1",
    "key2": "value2"
  }
}
```

### è¯»å–å±æ€§ (read)

```json
{
  "cmd": "read",
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "key": ["key1", "key2", "key3"]
  }
}
```

### å±æ€§è¿”å› (response)

```json
{
  "cmd": "read",
  "code": 200,
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "key1": "value1",
    "key2": "value2"
  }
}
```

---

## å•ä½è¯´æ˜ âš ï¸

**é‡è¦ï¼šCanvas ä½¿ç”¨ cmï¼ˆå˜ç±³ï¼‰ï¼Œé›·è¾¾è®¾å¤‡ä½¿ç”¨ dmï¼ˆåˆ†ç±³ï¼‰**

- **å‘é€åˆ°é›·è¾¾**ï¼šæ‰€æœ‰é•¿åº¦æ•°æ®éœ€è¦ **é™¤ä»¥10å¹¶å–æ•´**ï¼ˆcm â†’ dmï¼‰
- **ä»é›·è¾¾æ¥æ”¶**ï¼šæ‰€æœ‰é•¿åº¦æ•°æ®éœ€è¦ **ä¹˜ä»¥10**ï¼ˆdm â†’ cmï¼‰
- **é€‚ç”¨èŒƒå›´**ï¼šheightï¼ˆé«˜åº¦ï¼‰ã€boundaryï¼ˆè¾¹ç•Œï¼‰ã€area coordinatesï¼ˆåŒºåŸŸåæ ‡ï¼‰

---

## é…ç½®é¡¹è¯´æ˜

### 1. å®‰è£…æ¨¡å¼ (installModel)

| Canvaså€¼ | MQTT Key | MQTT Value |
|---------|----------|------------|
| ceiling | install_model | 0 |
| wall | install_model | 1 |
| corn | install_model | 2 |

**ç¤ºä¾‹å‘½ä»¤:**
```json
{
  "cmd": "update",
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "install_model": 1
  }
}
```

### 2. å®‰è£…é«˜åº¦ (height)

| Canvaså€¼ | MQTT Key | MQTT Value | è½¬æ¢ |
|---------|----------|------------|------|
| 300 cm | height | 30 | 300/10=30 dm |

**ç¤ºä¾‹ï¼šCanvas é«˜åº¦ 300cm â†’ é›·è¾¾ 30dm**
```json
{
  "cmd": "update",
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "height": 30  // æ³¨æ„ï¼šè¿™æ˜¯ dmï¼Œä¸æ˜¯ cm
  }
}
```

### 3. è¾¹ç•Œé…ç½® (boundary)

| Canvaså­—æ®µ | Canvaså€¼ | MQTT Key | MQTT Value | è½¬æ¢ |
|-----------|---------|----------|------------|------|
| leftH | 300 cm | boundary_left | 30 | 300/10=30 dm |
| rightH | 300 cm | boundary_right | 30 | 300/10=30 dm |
| frontV | 400 cm | boundary_front | 40 | 400/10=40 dm |
| rearV | 0 cm | boundary_rear | 0 | 0/10=0 dm |

**ç¤ºä¾‹ï¼šCanvas è¾¹ç•Œ L300/R300/F400/B0 (cm) â†’ é›·è¾¾ L30/R30/F40/B0 (dm)**
```json
{
  "cmd": "update",
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "boundary_left": 30,    // æ³¨æ„ï¼šè¿™æ˜¯ dm
    "boundary_right": 30,   // æ³¨æ„ï¼šè¿™æ˜¯ dm
    "boundary_front": 40,   // æ³¨æ„ï¼šè¿™æ˜¯ dm
    "boundary_rear": 0      // æ³¨æ„ï¼šè¿™æ˜¯ dm
  }
}
```

### 4. åŒºåŸŸé…ç½® (areas)

æ¯ä¸ªåŒºåŸŸç”± **4ä¸ªç‚¹çš„åæ ‡** å®šä¹‰ï¼ˆ{id} ä¸ºåŒºåŸŸç¼–å· 0-15ï¼‰:

| MQTT Key | è¯´æ˜ | å€¼ç±»å‹ |
|----------|------|--------|
| area_{id}_id | åŒºåŸŸID | æ•°å€¼ï¼ˆ-1è¡¨ç¤ºåˆ é™¤ï¼‰ |
| area_{id}_type | åŒºåŸŸç±»å‹ | å­—ç¬¦ä¸² |
| area_{id}_x1 | ç‚¹1 Xåæ ‡ | æ•°å€¼(cm) |
| area_{id}_y1 | ç‚¹1 Yåæ ‡ | æ•°å€¼(cm) |
| area_{id}_x2 | ç‚¹2 Xåæ ‡ | æ•°å€¼(cm) |
| area_{id}_y2 | ç‚¹2 Yåæ ‡ | æ•°å€¼(cm) |
| area_{id}_x3 | ç‚¹3 Xåæ ‡ | æ•°å€¼(cm) |
| area_{id}_y3 | ç‚¹3 Yåæ ‡ | æ•°å€¼(cm) |
| area_{id}_x4 | ç‚¹4 Xåæ ‡ | æ•°å€¼(cm) |
| area_{id}_y4 | ç‚¹4 Yåæ ‡ | æ•°å€¼(cm) |

**åŒºåŸŸæ ¼å¼è¯´æ˜ï¼š**
- åŒºåŸŸç”±4ä¸ªé¡¶ç‚¹å®šä¹‰ï¼Œ**é¡ºåºå›ºå®šï¼šå³ä¸Šã€å·¦ä¸Šã€å³ä¸‹ã€å·¦ä¸‹**ï¼ˆä¸è¾¹ç•Œ4é¡¶ç‚¹é¡ºåºç›¸åŒï¼‰
- å¯ä»¥æ˜¯çŸ©å½¢ã€å¹³è¡Œå››è¾¹å½¢æˆ–ä»»æ„å››è¾¹å½¢
- åæ ‡ç³»åŸºäºé›·è¾¾çš„å®‰è£…æ¨¡å¼

**é¡¶ç‚¹é¡ºåºå›¾ç¤ºï¼š**
```
(x2,y2) å·¦ä¸Š ---------- (x1,y1) å³ä¸Š
    |                      |
    |                      |
    |                      |
(x4,y4) å·¦ä¸‹ ---------- (x3,y3) å³ä¸‹
```

**ç¤ºä¾‹å‘½ä»¤ï¼ˆæ–°å¢åŒºåŸŸ 0 - çŸ©å½¢åºŠé“ºï¼‰:**

Canvas å€¼ï¼ˆcmï¼‰ï¼š
- å³ä¸Š: (200, 50)
- å·¦ä¸Š: (100, 50)
- å³ä¸‹: (200, 250)
- å·¦ä¸‹: (100, 250)

è½¬æ¢ä¸ºé›·è¾¾å€¼ï¼ˆdmï¼‰å¹¶å‘é€ï¼š
```json
{
  "cmd": "update",
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "area_0_id": 0,
    "area_0_type": "bed",
    "area_0_x1": 20,   // å³ä¸Š X (200cm/10=20dm)
    "area_0_y1": 5,    // å³ä¸Š Y (50cm/10=5dm)
    "area_0_x2": 10,   // å·¦ä¸Š X (100cm/10=10dm)
    "area_0_y2": 5,    // å·¦ä¸Š Y (50cm/10=5dm)
    "area_0_x3": 20,   // å³ä¸‹ X (200cm/10=20dm)
    "area_0_y3": 25,   // å³ä¸‹ Y (250cm/10=25dm)
    "area_0_x4": 10,   // å·¦ä¸‹ X (100cm/10=10dm)
    "area_0_y4": 25    // å·¦ä¸‹ Y (250cm/10=25dm)
  }
}
```

**ç¤ºä¾‹å‘½ä»¤ï¼ˆåˆ é™¤åŒºåŸŸ 1ï¼‰:**
```json
{
  "cmd": "update",
  "requestId": "req_1730534567890_abc123xyz",
  "data": {
    "area_1_id": -1,
    "area_1_x1": 0,
    "area_1_y1": 0,
    "area_1_x2": 0,
    "area_1_y2": 0,
    "area_1_x3": 0,
    "area_1_y3": 0,
    "area_1_x4": 0,
    "area_1_y4": 0
  }
}
```

---

## å®Œæ•´åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1: é¦–æ¬¡é…ç½®é›·è¾¾ï¼ˆwallæ¨¡å¼ï¼‰

**ç”¨æˆ·æ“ä½œ:**
1. è®¾ç½® installModel = wall
2. è®¾ç½® height = 170cm
3. è®¾ç½®è¾¹ç•Œ: L300/R300/F400/B0 (cm)

**ç”Ÿæˆçš„å‘½ä»¤åºåˆ—ï¼ˆVueè‡ªåŠ¨è½¬æ¢ä¸ºdmï¼‰:**

```javascript
// å‘½ä»¤ 1: è®¾ç½®å®‰è£…æ¨¡å¼
{
  "cmd": "update",
  "requestId": "req_1730534567890_cmd1",
  "data": {
    "install_model": 1  // wallï¼ˆæšä¸¾å€¼ï¼Œæ— éœ€è½¬æ¢ï¼‰
  }
}

// å‘½ä»¤ 2: è®¾ç½®å®‰è£…é«˜åº¦
{
  "cmd": "update",
  "requestId": "req_1730534567891_cmd2",
  "data": {
    "height": 17  // 170cm / 10 = 17dm
  }
}

// å‘½ä»¤ 3: è®¾ç½®è¾¹ç•Œ
{
  "cmd": "update",
  "requestId": "req_1730534567892_cmd3",
  "data": {
    "boundary_left": 30,    // 300cm / 10 = 30dm
    "boundary_right": 30,   // 300cm / 10 = 30dm
    "boundary_front": 40,   // 400cm / 10 = 40dm
    "boundary_rear": 0      // 0cm / 10 = 0dm
  }
}
```

### åœºæ™¯ 2: ä¿®æ”¹ç°æœ‰é…ç½®

**baselineï¼ˆQueryè¿”å›ï¼ŒCanvaså†…éƒ¨ä½¿ç”¨cmï¼‰:**
```json
{
  "installModel": "wall",
  "height": 170,  // cm
  "boundary": { "leftH": 300, "rightH": 300, "frontV": 400, "rearV": 0 },  // cm
  "areas": []
}
```

**ç”¨æˆ·ä¿®æ”¹:**
1. ä¿®æ”¹ height: 170cm â†’ 200cm
2. ä¿®æ”¹ frontV: 400cm â†’ 500cm

**å·®å¼‚å¯¹æ¯”ç»“æœ â†’ ç”Ÿæˆå‘½ä»¤ï¼ˆè‡ªåŠ¨è½¬æ¢ä¸ºdmï¼‰:**

```javascript
// å‘½ä»¤ 1: æ›´æ–°é«˜åº¦
{
  "cmd": "update",
  "requestId": "req_1730534567893_cmd1",
  "data": {
    "height": 20  // 200cm / 10 = 20dm
  }
}

// å‘½ä»¤ 2: æ›´æ–°è¾¹ç•Œ
{
  "cmd": "update",
  "requestId": "req_1730534567894_cmd2",
  "data": {
    "boundary_left": 30,    // 300cm / 10 = 30dm
    "boundary_right": 30,   // 300cm / 10 = 30dm
    "boundary_front": 50,   // 500cm / 10 = 50dmï¼ˆå˜åŒ–ï¼‰
    "boundary_rear": 0      // 0cm / 10 = 0dm
  }
}
```

### åœºæ™¯ 3: åˆ‡æ¢å®‰è£…æ¨¡å¼ï¼ˆwall â†’ ceilingï¼‰

**baseline (cm):**
```json
{
  "installModel": "wall",
  "height": 170,  // cm
  "boundary": { "leftH": 300, "rightH": 300, "frontV": 400, "rearV": 0 }  // cm
}
```

**ç”¨æˆ·ä¿®æ”¹:**
1. installModel: wall â†’ ceiling
2. height: 170cm â†’ 300cm
3. boundary: L300/R300/F400/B0 â†’ L300/R300/F200/B200 (cm)

**ç”Ÿæˆå‘½ä»¤åºåˆ—ï¼ˆæŒ‰é¡ºåºï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºdmï¼‰:**

```javascript
// å‘½ä»¤ 1: åˆ‡æ¢å®‰è£…æ¨¡å¼ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
{
  "cmd": "update",
  "requestId": "req_1730534567895_cmd1",
  "data": {
    "install_model": 0  // ceilingï¼ˆæšä¸¾å€¼ï¼Œæ— éœ€è½¬æ¢ï¼‰
  }
}

// å‘½ä»¤ 2: æ›´æ–°é«˜åº¦
{
  "cmd": "update",
  "requestId": "req_1730534567896_cmd2",
  "data": {
    "height": 30  // 300cm / 10 = 30dm
  }
}

// å‘½ä»¤ 3: æ›´æ–°è¾¹ç•Œ
{
  "cmd": "update",
  "requestId": "req_1730534567897_cmd3",
  "data": {
    "boundary_left": 30,    // 300cm / 10 = 30dm
    "boundary_right": 30,   // 300cm / 10 = 30dm
    "boundary_front": 20,   // 200cm / 10 = 20dm
    "boundary_rear": 20     // 200cm / 10 = 20dm
  }
}
```

### åœºæ™¯ 4: åŒºåŸŸç®¡ç†

**baseline (cm):**
```json
{
  "areas": [
    { 
      "areaId": 0, 
      "areaType": "zone", 
      "points": {
        "x1": 200, "y1": 50,   // å³ä¸Š (cm)
        "x2": 100, "y2": 50,   // å·¦ä¸Š (cm)
        "x3": 200, "y3": 200,  // å³ä¸‹ (cm)
        "x4": 100, "y4": 200   // å·¦ä¸‹ (cm)
      }
    }
  ]
}
```

**ç”¨æˆ·ä¿®æ”¹:**
1. åˆ é™¤åŒºåŸŸ 0
2. æ–°å¢åŒºåŸŸ 1ï¼ˆåºŠé“ºï¼Œ150x200cmï¼‰
3. æ–°å¢åŒºåŸŸ 2ï¼ˆæ´»åŠ¨åŒºï¼Œ100x150cmï¼‰

**ç”Ÿæˆå‘½ä»¤åºåˆ—ï¼ˆè‡ªåŠ¨è½¬æ¢ä¸ºdmï¼‰:**

```javascript
// å‘½ä»¤ 1: åˆ é™¤åŒºåŸŸ 0ï¼ˆä¼˜å…ˆæ‰§è¡Œåˆ é™¤ï¼‰
{
  "cmd": "update",
  "requestId": "req_1730534567898_cmd1",
  "data": {
    "area_0_id": -1,  // -1 è¡¨ç¤ºåˆ é™¤
    "area_0_x1": 0,
    "area_0_y1": 0,
    "area_0_x2": 0,
    "area_0_y2": 0,
    "area_0_x3": 0,
    "area_0_y3": 0,
    "area_0_x4": 0,
    "area_0_y4": 0
  }
}

// å‘½ä»¤ 2: æ–°å¢åŒºåŸŸ 1ï¼ˆåºŠé“ºï¼‰
{
  "cmd": "update",
  "requestId": "req_1730534567899_cmd2",
  "data": {
    "area_1_id": 1,
    "area_1_type": "bed",
    "area_1_x1": 25,   // å³ä¸Š X (250cm / 10 = 25dm)
    "area_1_y1": 5,    // å³ä¸Š Y (50cm / 10 = 5dm)
    "area_1_x2": 10,   // å·¦ä¸Š X (100cm / 10 = 10dm)
    "area_1_y2": 5,    // å·¦ä¸Š Y (50cm / 10 = 5dm)
    "area_1_x3": 25,   // å³ä¸‹ X (250cm / 10 = 25dm)
    "area_1_y3": 25,   // å³ä¸‹ Y (250cm / 10 = 25dm)
    "area_1_x4": 10,   // å·¦ä¸‹ X (100cm / 10 = 10dm)
    "area_1_y4": 25    // å·¦ä¸‹ Y (250cm / 10 = 25dm)
  }
}

// å‘½ä»¤ 3: æ–°å¢åŒºåŸŸ 2ï¼ˆæ´»åŠ¨åŒºï¼‰
{
  "cmd": "update",
  "requestId": "req_1730534567900_cmd3",
  "data": {
    "area_2_id": 2,
    "area_2_type": "activity",
    "area_2_x1": 20,   // å³ä¸Š X (200cm / 10 = 20dm)
    "area_2_y1": 10,   // å³ä¸Š Y (100cm / 10 = 10dm)
    "area_2_x2": 10,   // å·¦ä¸Š X (100cm / 10 = 10dm)
    "area_2_y2": 10,   // å·¦ä¸Š Y (100cm / 10 = 10dm)
    "area_2_x3": 20,   // å³ä¸‹ X (200cm / 10 = 20dm)
    "area_2_y3": 25,   // å³ä¸‹ Y (250cm / 10 = 25dm)
    "area_2_x4": 10,   // å·¦ä¸‹ X (100cm / 10 = 10dm)
    "area_2_y4": 25    // å·¦ä¸‹ Y (250cm / 10 = 25dm)
  }
}
```

---

## å‘½ä»¤æ‰§è¡Œé¡ºåº

ç³»ç»Ÿä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è‡ªåŠ¨æ’åºå‘½ä»¤ï¼š

1. **installModel** (å®‰è£…æ¨¡å¼) - ä¼˜å…ˆçº§æœ€é«˜
2. **height** (å®‰è£…é«˜åº¦)
3. **boundary** (è¾¹ç•Œé…ç½®)
4. **area_delete** (åˆ é™¤åŒºåŸŸ)
5. **area_update** (æ›´æ–°åŒºåŸŸ)
6. **area_add** (æ–°å¢åŒºåŸŸ) - ä¼˜å…ˆçº§æœ€ä½

**åŸå› :**
- å®‰è£…æ¨¡å¼å˜åŒ–ä¼šå½±å“åæ ‡ç³»ï¼Œå¿…é¡»æœ€å…ˆæ‰§è¡Œ
- é«˜åº¦å’Œè¾¹ç•Œå®šä¹‰äº†æ£€æµ‹èŒƒå›´ï¼Œå…¶æ¬¡æ‰§è¡Œ
- åŒºåŸŸæ˜¯åœ¨è¾¹ç•Œå†…çš„ç»†åˆ†ï¼Œæœ€åæ‰§è¡Œ
- åˆ é™¤æ“ä½œä¼˜å…ˆäºæ–°å¢/æ›´æ–°ï¼Œé¿å…IDå†²çª

---

## æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹ï¼ˆæœåŠ¡å™¨å“åº”æ¨¡å¼ï¼‰

å½“ç”¨æˆ·ç‚¹å‡» IoTSave æŒ‰é’®æ—¶ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºï¼š

### åœºæ™¯1ï¼šå…¨éƒ¨æˆåŠŸ

```
ğŸš€ å¼€å§‹æ‰§è¡Œé›·è¾¾é…ç½®å‘½ä»¤...

ğŸ“¡ [1/3] å®‰è£…æ¨¡å¼: wall â†’ ceiling
   è®¾å¤‡ID: device-uuid-001
   RequestID: req_1730534567895_abc123xyz
   Key/Valueæ•°é‡: 1
   - install_model: 0
   â† æœåŠ¡å™¨å“åº” (code: 200)
âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (code: 200)
   æœåŠ¡å™¨è¿”å›: {
  "install_model": 0
}

ğŸ“¡ [2/3] å®‰è£…é«˜åº¦: 170cm â†’ 300cm
   è®¾å¤‡ID: device-uuid-001
   RequestID: req_1730534568123_def456uvw
   Key/Valueæ•°é‡: 1
   - height: 300
   â† æœåŠ¡å™¨å“åº” (code: 200)
âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (code: 200)
   æœåŠ¡å™¨è¿”å›: {
  "height": 300
}

ğŸ“¡ [3/3] è¾¹ç•ŒèŒƒå›´: L300/R300/F400/B0 â†’ L300/R300/F200/B200
   è®¾å¤‡ID: device-uuid-001
   RequestID: req_1730534568456_ghi789rst
   Key/Valueæ•°é‡: 4
   - boundary_left: 300
   - boundary_right: 300
   - boundary_front: 200
   - boundary_rear: 200
   â† æœåŠ¡å™¨å“åº” (code: 200)
âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (code: 200)
   æœåŠ¡å™¨è¿”å›: {
  "boundary_left": 300,
  "boundary_right": 300,
  "boundary_front": 200,
  "boundary_rear": 200
}

âœ… æ‰€æœ‰å‘½ä»¤æ‰§è¡Œå®Œæˆ (3/3)
âœ… æ‰€æœ‰å‘½ä»¤æ‰§è¡ŒæˆåŠŸ
ğŸ’¾ é…ç½®ä¿å­˜æˆåŠŸï¼æ‰€æœ‰å‘½ä»¤å·²æ‰§è¡Œã€‚
```

### åœºæ™¯2ï¼šéƒ¨åˆ†å¤±è´¥

```
ğŸš€ å¼€å§‹æ‰§è¡Œé›·è¾¾é…ç½®å‘½ä»¤...

ğŸ“¡ [1/3] å®‰è£…æ¨¡å¼: wall â†’ ceiling
   è®¾å¤‡ID: device-uuid-001
   RequestID: req_1730534567895_abc123xyz
   Key/Valueæ•°é‡: 1
   - install_model: 0
   â† æœåŠ¡å™¨å“åº” (code: 200)
âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (code: 200)
   æœåŠ¡å™¨è¿”å›: {...}

ğŸ“¡ [2/3] å®‰è£…é«˜åº¦: 170cm â†’ 300cm
   è®¾å¤‡ID: device-uuid-001
   RequestID: req_1730534568123_def456uvw
   Key/Valueæ•°é‡: 1
   - height: 300
   â† æœåŠ¡å™¨å“åº” (code: 400)
âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: æœåŠ¡å™¨è¿”å›é”™è¯¯ç : 400
   
ğŸ“¡ [3/3] è¾¹ç•ŒèŒƒå›´: L300/R300/F400/B0 â†’ L300/R300/F200/B200
   è®¾å¤‡ID: device-uuid-001
   RequestID: req_1730534568456_ghi789rst
   Key/Valueæ•°é‡: 4
   - boundary_left: 300
   - boundary_right: 300
   - boundary_front: 200
   - boundary_rear: 200
   â† æœåŠ¡å™¨å“åº” (code: 200)
âœ… å‘½ä»¤æ‰§è¡ŒæˆåŠŸ (code: 200)
   æœåŠ¡å™¨è¿”å›: {...}

âš ï¸ å‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œ1 ä¸ªå¤±è´¥ (2/3)
âŒ éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œå¤±è´¥
ğŸ” æ‰§è¡Œæ‰‹åŠ¨Queryï¼Œè·å–è®¾å¤‡å½“å‰çŠ¶æ€...
   ğŸ“¡ å‘é€Queryå‘½ä»¤: {...}
   âœ… Queryå®Œæˆï¼Œè§£æåçš„é…ç½®: {...}

âš ï¸ éƒ¨åˆ†é…ç½®å†™å…¥å¤±è´¥ï¼š
  - å®‰è£…é«˜åº¦: 170cm â†’ 300cm: æœåŠ¡å™¨è¿”å›é”™è¯¯ç : 400

baselineå·²æ›´æ–°ä¸ºè®¾å¤‡å½“å‰çŠ¶æ€ã€‚
```

### åœºæ™¯3ï¼šè¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯

```
ğŸš€ å¼€å§‹æ‰§è¡Œé›·è¾¾é…ç½®å‘½ä»¤...

ğŸ“¡ [1/3] å®‰è£…æ¨¡å¼: wall â†’ ceiling
   è®¾å¤‡ID: device-uuid-001
   RequestID: req_1730534567895_abc123xyz
   Key/Valueæ•°é‡: 1
   - install_model: 0
âŒ å‘½ä»¤æ‰§è¡Œå¤±è´¥: ç­‰å¾…æœåŠ¡å™¨å“åº”è¶…æ—¶ï¼ˆ10ç§’ï¼‰

âš ï¸ å‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œ1 ä¸ªå¤±è´¥ (0/3)
âŒ éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œå¤±è´¥
ğŸ” æ‰§è¡Œæ‰‹åŠ¨Queryï¼Œè·å–è®¾å¤‡å½“å‰çŠ¶æ€...
```

---

## é›†æˆåˆ°å®é™…MQTTå®¢æˆ·ç«¯

### æ ¸å¿ƒå®ç°ï¼šWriteRadar å‡½æ•°

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œéœ€è¦å®ç° **requestId åŒ¹é…æœºåˆ¶**ï¼š

```typescript
// ç¤ºä¾‹ï¼šä½¿ç”¨ mqtt.js
import mqtt from 'mqtt';

const mqttClient = mqtt.connect('mqtt://broker.example.com:1883');
const productId = 'your-product-id';

// å¿…é¡»å…ˆè®¢é˜…æ‰€æœ‰è®¾å¤‡çš„ post ä¸»é¢˜
mqttClient.subscribe(`prop/${productId}/+/post`);

const WriteRadar = async (command: RadarCommand): Promise<MqttResponse> => {
  const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const mqttCommand = buildMqttUpdateCommand(command.mqttKeyValues, requestId);
  
  // å‘é€ä¸»é¢˜
  const getTopic = `prop/${productId}/${command.deviceId}/get`;
  // å“åº”ä¸»é¢˜
  const postTopic = `prop/${productId}/${command.deviceId}/post`;
  
  return new Promise((resolve, reject) => {
    // 1. è®¾ç½®è¶…æ—¶ï¼ˆ10ç§’ï¼‰
    const timeout = setTimeout(() => {
      mqttClient.off('message', messageHandler);
      reject(new Error('ç­‰å¾…æœåŠ¡å™¨å“åº”è¶…æ—¶ï¼ˆ10ç§’ï¼‰'));
    }, 10000);
    
    // 2. ç›‘å¬å“åº”æ¶ˆæ¯
    const messageHandler = (topic: string, payload: Buffer) => {
      // åªå¤„ç†å½“å‰è®¾å¤‡çš„å“åº”
      if (topic === postTopic) {
        try {
          const response: MqttResponse = JSON.parse(payload.toString());
          
          // 3. å…³é”®ï¼šæ ¹æ® requestId åŒ¹é…å“åº”
          if (response.requestId === requestId) {
            clearTimeout(timeout);
            mqttClient.off('message', messageHandler);
            resolve(response);  // è¿”å›å®Œæ•´å“åº”ï¼ˆåŒ…å« code å’Œ dataï¼‰
          }
          // å¦‚æœ requestId ä¸åŒ¹é…ï¼Œç»§ç»­ç­‰å¾…
        } catch (error) {
          clearTimeout(timeout);
          mqttClient.off('message', messageHandler);
          reject(new Error('è§£ææœåŠ¡å™¨å“åº”å¤±è´¥'));
        }
      }
    };
    
    // 4. æ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨
    mqttClient.on('message', messageHandler);
    
    // 5. å‘å¸ƒå‘½ä»¤
    mqttClient.publish(getTopic, JSON.stringify(mqttCommand), (error) => {
      if (error) {
        clearTimeout(timeout);
        mqttClient.off('message', messageHandler);
        reject(new Error(`å‘å¸ƒMQTTæ¶ˆæ¯å¤±è´¥: ${error.message}`));
      }
    });
  });
};
```

### å…³é”®ç‚¹è¯´æ˜

1. **æå‰è®¢é˜… post ä¸»é¢˜**
   ```typescript
   // åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶è®¢é˜…ï¼Œä½¿ç”¨é€šé…ç¬¦ + åŒ¹é…æ‰€æœ‰è®¾å¤‡
   mqttClient.subscribe(`prop/${productId}/+/post`);
   ```

2. **requestId å¿…é¡»å…¨å±€å”¯ä¸€**
   ```typescript
   // ä½¿ç”¨æ—¶é—´æˆ³ + éšæœºå­—ç¬¦ä¸²ä¿è¯å”¯ä¸€æ€§
   const requestId = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
   ```

3. **å“åº”åŒ¹é…æœºåˆ¶**
   ```typescript
   // æœåŠ¡å™¨è¿”å›çš„ requestId å¿…é¡»ä¸å‘é€çš„ä¸€è‡´
   if (response.requestId === requestId) {
     resolve(response);
   }
   ```

4. **è¶…æ—¶å¤„ç†**
   ```typescript
   // 10ç§’åå¦‚æœè¿˜æ²¡æ”¶åˆ°å“åº”ï¼Œè®¤ä¸ºè¶…æ—¶
   setTimeout(() => {
     reject(new Error('ç­‰å¾…æœåŠ¡å™¨å“åº”è¶…æ—¶ï¼ˆ10ç§’ï¼‰'));
   }, 10000);
   ```

5. **æ¸…ç†ç›‘å¬å™¨**
   ```typescript
   // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½è¦ç§»é™¤ç›‘å¬å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
   mqttClient.off('message', messageHandler);
   ```

### MQTTå“åº”æ ¼å¼

æœåŠ¡å™¨å¿…é¡»è¿”å›ä»¥ä¸‹æ ¼å¼ï¼š

```typescript
interface MqttResponse {
  cmd: 'update' | 'read';
  code: string;           // "200" = æˆåŠŸï¼Œ"500" = å¤±è´¥ï¼ˆStringç±»å‹ï¼‰
  requestId: string;      // å¿…é¡»ä¸è¯·æ±‚ä¸­çš„ requestId ä¸€è‡´
  data: Record<string, any>;  // å†™å…¥åçš„å®é™…å€¼
}
```

**âš ï¸ é‡è¦ï¼šcode æ˜¯ String ç±»å‹ï¼Œä¸æ˜¯ numberï¼**

### ç¤ºä¾‹å“åº”

**æˆåŠŸå“åº”:**
```json
{
  "cmd": "update",
  "code": "200",
  "requestId": "req_1730534567895_abc123xyz",
  "data": {
    "install_model": 1,
    "height": 300
  }
}
```

**å¤±è´¥å“åº”:**
```json
{
  "cmd": "update",
  "code": "500",
  "requestId": "req_1730534567895_abc123xyz",
  "data": {
    "error": "å‚æ•°éªŒè¯å¤±è´¥",
    "message": "height è¶…å‡ºå…è®¸èŒƒå›´"
  }
}
```

**æ‰§è¡Œæ—¶é—´ï¼š**
- åŒæ­¥æ¨¡å¼ï¼Œå‘½ä»¤æ‰§è¡Œéœ€è¦ 5-8 ç§’
- å®¢æˆ·ç«¯ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼Œè¶…æ—¶æ—¶é—´å»ºè®®è®¾ç½®ä¸º 10 ç§’

---

## å†™å…¥éªŒè¯æµç¨‹ï¼ˆåŸºäºMQTTå“åº”ï¼‰

**IoTSave å®Œæ•´æµç¨‹:**

```
1. ç”¨æˆ·ä¿®æ”¹é…ç½®
   â†“
2. ç‚¹å‡» IoTSave æŒ‰é’®
   â†“
3. å¯¹æ¯” currentConfig vs baseline
   â†“
4. ç”Ÿæˆå·®å¼‚å‘½ä»¤åˆ—è¡¨
   â†“
5. ç”¨æˆ·ç¡®è®¤è¦å†™å…¥çš„å˜æ›´
   â†“
6. å¯¹æ¯æ¡å‘½ä»¤ï¼š
   â”œâ”€ å‘é€ MQTT Update å‘½ä»¤ï¼ˆå¸¦ requestIdï¼‰
   â”œâ”€ ç›‘å¬ post ä¸»é¢˜ç­‰å¾…å“åº”
   â”œâ”€ æ ¹æ® requestId åŒ¹é…å“åº”
   â””â”€ æ£€æŸ¥ codeï¼ˆ200=æˆåŠŸï¼Œå…¶ä»–=å¤±è´¥ï¼‰
   â†“
7. æ ¹æ®æ‰§è¡Œç»“æœï¼š
   â”œâ”€ å…¨éƒ¨æˆåŠŸï¼šæ›´æ–° baseline = currentConfig
   â””â”€ éƒ¨åˆ†å¤±è´¥ï¼šæ‰‹åŠ¨ Query è·å–çœŸå®çŠ¶æ€
   â†“
8. æ˜¾ç¤ºæ‰§è¡Œç»“æœ
```

**ä¸¤ç§éªŒè¯æ¨¡å¼ï¼š**

### æ¨¡å¼1ï¼šæœåŠ¡å™¨å“åº”éªŒè¯ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
- âœ… å¿«é€Ÿï¼šæ— éœ€é¢å¤–ç­‰å¾…
- âœ… å®æ—¶ï¼šç«‹å³çŸ¥é“æ‰§è¡Œç»“æœ
- âœ… ä¾èµ–æœåŠ¡å™¨è¿”å›çš„ code å’Œ data

### æ¨¡å¼2ï¼šæ‰‹åŠ¨QueryéªŒè¯ï¼ˆå¯é€‰ï¼‰
- âœ… å¯é ï¼šä»è®¾å¤‡å®é™…è¯»å–é…ç½®
- âš ï¸ è¾ƒæ…¢ï¼šéœ€è¦ç­‰å¾… + é¢å¤–Query
- âœ… é€‚åˆå¯¹æœåŠ¡å™¨å“åº”ä¸å®Œå…¨ä¿¡ä»»çš„åœºæ™¯

åœ¨ä»£ç ä¸­è®¾ç½® `needManualVerify = true` å¯å¯ç”¨åŒé‡éªŒè¯ã€‚

**éªŒè¯ç»“æœç¤ºä¾‹:**

âœ… **å…¨éƒ¨æˆåŠŸ:**
```
âœ… æ‰€æœ‰é…ç½®å†™å…¥æˆåŠŸå¹¶å·²éªŒè¯
- å®‰è£…æ¨¡å¼: âœ…
- å®‰è£…é«˜åº¦: âœ…
- è¾¹ç•ŒèŒƒå›´: âœ…
```

âš ï¸ **éƒ¨åˆ†å¤±è´¥:**
```
âš ï¸ éƒ¨åˆ†é…ç½®å†™å…¥å¤±è´¥

ä»¥ä¸‹é¡¹ç›®éªŒè¯å¤±è´¥ï¼š
  - å‰è¾¹ç•Œä¸åŒ¹é…: æœŸæœ› 500, å®é™… 400
  - åŒºåŸŸ 1 æœªæ‰¾åˆ°

è¯·æ£€æŸ¥è®¾å¤‡çŠ¶æ€æˆ–é‡è¯•ã€‚
```

## æ³¨æ„äº‹é¡¹

### å…³é”®æœºåˆ¶

1. **requestId å…¨å±€å”¯ä¸€æ€§** â­
   - ä½¿ç”¨ `æ—¶é—´æˆ³ + éšæœºå­—ç¬¦ä¸²` ä¿è¯å”¯ä¸€
   - æœåŠ¡å™¨å¿…é¡»åŸæ ·è¿”å› requestId
   - å®¢æˆ·ç«¯é€šè¿‡ requestId åŒ¹é…å“åº”

2. **æœåŠ¡å™¨å“åº”éªŒè¯**ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
   - å‘é€å‘½ä»¤åç­‰å¾…æœåŠ¡å™¨å“åº”
   - æ£€æŸ¥è¿”å›çš„ `code`ï¼ˆ200 = æˆåŠŸï¼‰
   - å¦‚æœå…¨éƒ¨æˆåŠŸï¼Œç›´æ¥æ›´æ–° baseline
   - å¦‚æœæœ‰å¤±è´¥ï¼Œæ‰‹åŠ¨ Query è·å–çœŸå®çŠ¶æ€

3. **å¯é€‰ï¼šæ‰‹åŠ¨éªŒè¯æ¨¡å¼**
   - é€‚åˆä¸å®Œå…¨ä¿¡ä»»æœåŠ¡å™¨å“åº”çš„åœºæ™¯
   - è®¾ç½® `needManualVerify = true`
   - å³ä½¿æœåŠ¡å™¨è¿”å›æˆåŠŸï¼Œä¹Ÿä¼šæ‰‹åŠ¨ Query éªŒè¯

4. **å‘½ä»¤æ‰§è¡Œé¡ºåº**
   - installModel â†’ height â†’ boundary â†’ area_delete â†’ area_update â†’ area_add
   - å‘½ä»¤é—´å»¶è¿Ÿ 300msï¼Œé˜²æ­¢è®¾å¤‡å¤„ç†ä¸è¿‡æ¥

5. **å·®å¼‚æ£€æµ‹**
   - åªæœ‰å®é™…å˜åŒ–çš„é…ç½®æ‰ä¼šç”Ÿæˆå‘½ä»¤
   - é¿å…ä¸å¿…è¦çš„è®¾å¤‡æ“ä½œ
   - å‡å°‘ç½‘ç»œæµé‡

6. **baseline æœºåˆ¶**
   - å¿…é¡»å…ˆ Query è·å– baselineï¼Œæ‰èƒ½æ‰§è¡Œ Save
   - å…¨éƒ¨æˆåŠŸï¼šbaseline = currentConfig
   - éƒ¨åˆ†å¤±è´¥ï¼šbaseline = Query è·å–çš„çœŸå®çŠ¶æ€

7. **è¶…æ—¶å¤„ç†**
   - é»˜è®¤ 10 ç§’è¶…æ—¶
   - è¶…æ—¶åæŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘æ‰‹åŠ¨ Query

8. **é”™è¯¯å¤„ç†**
   - ä»»ä½•å‘½ä»¤å¤±è´¥ä¸ä¼šä¸­æ–­åç»­æ‰§è¡Œï¼ˆç»§ç»­æ‰§è¡Œå‰©ä½™å‘½ä»¤ï¼‰
   - æœ€åç»Ÿä¸€å¤„ç†å¤±è´¥é¡¹
   - å¤±è´¥æ—¶æ‰‹åŠ¨ Query ç¡®ä¿ baseline å‡†ç¡®

9. **å†…å­˜æ³„æ¼é˜²æŠ¤**
   - å“åº”åç«‹å³ç§»é™¤æ¶ˆæ¯ç›‘å¬å™¨
   - è¶…æ—¶åä¹Ÿè¦ç§»é™¤ç›‘å¬å™¨

### æ€§èƒ½ä¼˜åŒ–

- âœ… åªå†™å…¥å˜åŒ–çš„é…ç½®ï¼ˆå·®å¼‚æ£€æµ‹ï¼‰
- âœ… ä¾èµ–æœåŠ¡å™¨å“åº”ï¼Œæ— éœ€é¢å¤–ç­‰å¾…ï¼ˆå¿«é€ŸéªŒè¯ï¼‰
- âœ… å‘½ä»¤å¤±è´¥æ—¶æ‰æ‰‹åŠ¨ Queryï¼ˆæŒ‰éœ€éªŒè¯ï¼‰
- âœ… å‘½ä»¤é—´ 300ms å»¶è¿Ÿï¼Œå¹³è¡¡é€Ÿåº¦å’Œå¯é æ€§


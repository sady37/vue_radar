# Toolbar 操作流程说明

## ✅ 正确的操作逻辑（B方案修正版）

### 核心理念
1. **先选类型** → 工具自动激活 → 在Canvas画图 → 自动设置类型
2. **家具按钮**：点击后自动激活对应的绘图工具
3. **IoT设备**：点击直接生成，无需画图
4. **Read/Write**：仅IoT设备可用，用于与实际硬件通信

---

## 📝 完整操作流程

### 流程1：添加床（家具）✅ 正确流程

```
步骤1: 点击家具按钮
┌─────────────────────────┐
│ ✅ 点击 🛏️ Bed          │ → Bed按钮高亮
│                         │ → Rectangle自动高亮
│                         │ → 进入绘图模式
└─────────────────────────┘

步骤2: 在Canvas上绘制
┌─────────────────────────┐
│ Canvas                  │
│  ┌─拖动鼠标─────┐       │ → 实时显示几何属性
│  │    W: 200    │       │   L: 长度
│  │  ╔═══════╗   │       │   W: 宽度
│  │  ║  床   ║ L:│       │   颜色: #0cade3
│  │  ╚═══════╝ 150       │
│  └──────────────┘       │
└─────────────────────────┘

步骤3: 完成绘制（松开鼠标）
┌─────────────────────────┐
│ 自动完成                │ → 自动设为Bed
│                         │ → 自动应用蓝灰色
│                         │ → 自动选中
│                         │ → 显示属性编辑区
└─────────────────────────┘

步骤4: 编辑属性（可选）
┌─────────────────────────┐
│ 📝 属性编辑区           │
│ Name: [双人床_____]     │ → 修改名称
│ L: [200]  W: [150]      │ → 微调尺寸
│ H: [80]                 │ → 设置高度
│ 反射率: [0.8]           │ → 设置反射率
│ ☑ 仅边框                │ → 显示选项
└─────────────────────────┘

步骤5: 保存（可选）
┌─────────────────────────┐
│ ✅ 点击 💾 Save         │ → 确认保存编辑
└─────────────────────────┘
```

**关键点**：
- ✅ 先选家具类型（Bed）
- ✅ 工具自动激活（Rectangle）
- ✅ 画完自动设置类型
- ✅ 不需要手动点击设置类型

---

### 流程2：添加雷达（IoT设备）✅ 正确流程

```
步骤1: 点击IoT设备按钮
┌─────────────────────────┐
│ ✅ 点击 📡 Radar        │ → 直接生成！
│                         │ → 位置: (0, 10)
│                         │ → 高度: 280cm
│                         │ → 颜色: #2196F3
│                         │ → 自动选中
└─────────────────────────┘

步骤2: 拖动调整位置（可选）
┌─────────────────────────┐
│ Canvas                  │
│         📡              │ → 拖动到合适位置
│       雷达              │
└─────────────────────────┘

步骤3: 配置雷达参数
┌─────────────────────────┐
│ 📝 属性编辑区           │
│ Name: [卧室雷达_____]   │
│                         │
│ IoT 配置:               │
│ Status: [Offline] ⚪    │
│ Setup: [Ceiling ▼]      │ → 选择安装模式
│ Work: [Vital Sign ▼]    │ → 选择工作模式
│                         │
│ 边界:                   │
│ 左: [280]  右: [280]    │
│ 前: [200]  后: [200]    │
│                         │
│ ☑ 显示边界              │
│ ☑ 显示信号区            │
└─────────────────────────┘

步骤4: 写入到实际设备
┌─────────────────────────┐
│ ✅ 点击 ✍️ Write        │ → 将配置写入硬件
│    (按钮高亮可用🟢)     │ → 调用API
└─────────────────────────┘
```

**关键点**：
- ✅ 点击直接生成，无需画图
- ✅ 预设位置和颜色
- ✅ Read/Write按钮自动高亮
- ✅ 可拖动调整位置

---

### 流程3：从设备读取配置

```
前提: 已选中IoT设备

步骤1: Read按钮高亮
┌─────────────────────────┐
│ 📖 Read  ✍️ Write       │
│   🟢      🟢             │ → 两按钮都高亮可用
└─────────────────────────┘

步骤2: 读取配置
┌─────────────────────────┐
│ ✅ 点击 📖 Read         │ → 从硬件读取当前配置
│                         │ → 更新到界面
└─────────────────────────┘

步骤3: 配置自动更新
┌─────────────────────────┐
│ 📝 属性编辑区           │
│                         │
│ IoT 配置:               │
│ Status: [Online] 🟢     │ ← 自动更新
│ Setup: [Wall ▼]         │ ← 从设备读取
│                         │
│ 边界:                   │
│ 左: [280]  右: [280]    │ ← 实际值
│ 前: [350]  后: [0]      │ ← 从设备读取
└─────────────────────────┘
```

---

## 🔧 按钮功能详解 ✅ 正确说明

### 第1区：绘图工具（可独立使用）

| 按钮 | 功能 | 状态 |
|------|------|------|
| 📏 Line | 绘制线段 | 点击激活，再次点击取消 |
| ▭ Rectangle | 绘制矩形 | 激活后在canvas拖拽 |
| ◔ Sector | 绘制扇形 | 点中心→点边缘→拖弧度 |
| ⭕ Circle | 绘制圆形 | 点中心→拖半径 |

**行为**：
- ✅ 点击激活（高亮显示）
- ✅ 可单独使用，画出的图形为"Other"类型
- ✅ 也会被家具按钮自动激活
- ✅ 在Canvas上可以拖拽绘制
- ✅ 绘制时实时显示几何参数
- ✅ 完成后自动选中图形

---

### 第2区：家具/结构按钮（自动激活绘图工具）

| 按钮 | 自动激活工具 | 默认颜色 | 行为 |
|------|------------|---------|------|
| 🛏️ Bed | Rectangle | #0cade3 蓝灰 | 点击后→Rectangle自动高亮→画图→完成后自动设为Bed |
| 🚪 Enter | Rectangle | #a0eda0 灰绿 | 点击后→Rectangle自动高亮→画图→完成后自动设为Enter |
| ⚡ Exclude | Rectangle | #c0c0c0 银色 | 点击后→Rectangle自动高亮→画图→完成后自动设为Exclude |
| Wall | Line | #000000 黑色 | 点击后→Line自动高亮→画图→完成后自动设为Wall |
| 🪑 Table | Rectangle | #8b4513 棕色 | 点击后→Rectangle自动高亮→画图→完成后自动设为Table |
| 📺 Curtain | Rectangle | #4682b4 钢蓝 | 点击后→Rectangle自动高亮→画图→完成后自动设为Curtain |
| 📦 Other | Rectangle | #d3d3d3 灰色 | 点击后→Rectangle自动高亮→画图→完成后自动设为Other |

**关键行为**：
- ✅ **无需先画图**，点击家具即自动进入对应的绘图模式
- ✅ 家具按钮和工具按钮**同时高亮**
- ✅ 画完自动设置类型和颜色
- ✅ 不需要手动点击"设置为XXX"

---

### 第3区：IoT设备按钮（直接生成）

| 按钮 | 功能 | 颜色 | 行为 |
|------|------|------|------|
| 📡 Radar | 添加雷达 | #2196F3 蓝色 | 点击直接生成到(0,10,z:280) |
| 🛏️ SleepAd | 添加睡眠监测 | #9C27B0 紫色 | 点击直接生成到(0,100,z:100) |
| 🔍 Sensor | 添加传感器 | #FF9800 橙色 | 点击直接生成到(100,100,z:150) |

**关键行为**：
- ✅ **无需画图**，点击直接在Canvas生成设备图标
- ✅ 自动设置预设位置和高度
- ✅ 自动应用设备颜色
- ✅ 自动创建IoT配置（deviceId, setupModel等）
- ✅ 可拖动调整位置
- 属性区显示IoT配置选项

---

### 第4区：操作按钮 ✅ 正确说明

| 按钮 | 功能 | 启用条件 | 说明 |
|------|------|---------|------|
| ✨ Create | 创建对象 | 选中家具或工具时 | 当家具类型或绘图工具激活时可用 |
| 🗑️ Delete | 删除选中 | Canvas上有选中对象 | 删除当前选中的对象 |
| 💾 Save | 保存编辑 | 有编辑操作时 | 确认保存当前图形的编辑 |
| 📖 Read | 读取配置 | **仅IoT设备选中**🟢 | 从硬件读取配置，按钮绿色高亮 |
| ✍️ Write | 写入配置 | **仅IoT设备选中**🟢 | 写入配置到硬件，按钮绿色高亮 |
| 📤 Export | 导出布局 | 始终可用 | 导出所有对象到JSON |
| 📥 Import | 导入布局 | 始终可用 | 从JSON导入对象 |
| ❤️ Vital | 生命体征 | 始终可用 | 切换生命体征显示 |

**关键行为**：
- ✅ **Create**：当`pendingObjectType`或`drawingMode`激活时可用
- ✅ **Delete**：只有Canvas上有选中对象时可用
- ✅ **Read/Write**：只在选中IoT设备时高亮🟢可用
- ✅ 选中家具时，Read/Write灰显不可用

---

## 🎨 视觉反馈

### 绘图工具激活状态
```css
激活: 蓝色背景 + 白字 + 加粗
未激活: 白色背景 + 黑字
```

### Read/Write 按钮状态
```css
可用(选中IoT): 绿色背景 + 白字 + 加粗
不可用: 灰色 + 40%透明度 + 禁用光标
```

### 绘制过程
```
Canvas上显示:
- 虚线预览
- 实时尺寸标注
- 鼠标坐标
```

---

## 🔄 数据流向 ✅ 正确流程

### 家具绘图流程（先选类型）
```
Toolbar               Canvas Store          Canvas
───────               ────────────          ──────
点击Bed ──────►     pendingObjectType = 'Bed'
                    setDrawingMode('rectangle')
                          │
                          ▼
                    drawingMode = 'rectangle'
                          │
                          ▼
                                        ◄──── 监听drawingMode
                                              进入绘图模式
                                              显示"将创建Bed"提示

拖拽绘制 ────────────────────►        实时计算尺寸
                                        预览为蓝灰色

松开鼠标 ────────────────────►        完成绘制
                                              │
                                              ▼
                                        objectsStore.addObject({
                                          typeName: 'Bed',
                                          color: '#0cade3'
                                        })
                                              │
                                              ▼
                                        自动选中新对象
```

### IoT设备添加流程（直接生成）
```
Toolbar               Objects Store         Canvas
───────               ─────────────         ──────
点击Radar ──────►   addDevice('Radar')
                          │
                          ▼
                    生成预设配置 {
                      typeName: 'Radar',
                      geometry: point(0,10,280),
                      color: '#2196F3',
                      device: { iot: {...} }
                    }
                          │
                          ▼
                    addObject()
                          │
                          ▼
                                        ◄──── 立即渲染
                                              显示雷达图标
                                              可拖动调整
```

### Read/Write 流程
```
Toolbar               Objects Store         Hardware API
───────               ─────────────         ────────────
选中雷达 ◄──────────  selectedObject
     │                    │
     ▼                    ▼
isIotDevice = true   device.category = 'iot'
     │
     ▼
Read/Write高亮

点击Read ──────►     获取deviceId
                          │
                          ▼
                    调用API  ────────────►  读取硬件配置
                          │                      │
                          ◄──────────────────────┘
                          │
                          ▼
                    updateObject(config)
```

---

## ⚠️ 注意事项 ✅ 正确说明

### 1. 家具添加流程
- ✅ **先点击家具类型**（如Bed），不是先点工具
- ✅ 工具会自动激活
- ✅ 画完后自动设置类型和颜色
- ✅ 无需手动"设置为XXX"

### 2. IoT设备添加流程
- ✅ **点击直接生成**，不需要画图
- ✅ 自动创建预设配置
- ✅ 可拖动调整位置
- ✅ Read/Write按钮自动高亮

### 3. 直接使用绘图工具
- ✅ 可以不选家具，直接用工具画图
- ✅ 画出的图形默认为"Other"类型
- ✅ 后期可在属性区改类型

### 4. Read/Write 使用
- ✅ **必须选中IoT设备**才可用
- ✅ 选中IoT设备时按钮绿色高亮🟢
- ✅ 选中家具时按钮灰显不可用
- ✅ Read：从硬件读取当前配置
- ✅ Write：将界面配置写入硬件

### 5. 按钮启用逻辑
- ✅ Create：家具类型或工具激活时可用
- ✅ Delete：Canvas上有选中对象时可用
- ✅ Read/Write：只有IoT设备选中时可用

---

## 🧪 测试场景 ✅ 正确流程

### 场景1：添加床（家具）✅ 正确
1. ✅ 点击 🛏️ Bed（Bed和Rectangle同时高亮）
2. ✅ 在Canvas拖拽绘制矩形
3. ✅ 看到实时尺寸显示（L: 200, W: 150）
4. ✅ 松手后矩形完成，自动设为Bed，蓝灰色
5. ✅ 属性区自动显示床的属性
6. ✅ 修改L/W/H（可选）
7. ✅ 点击Save保存（可选）

### 场景2：添加雷达（IoT）✅ 正确
1. ✅ 点击 📡 Radar（直接生成，无需画图）
2. ✅ Canvas上立即显示雷达图标在(0,10)
3. ✅ 确认Read/Write按钮变为绿色高亮🟢
4. ✅ 拖动调整位置（可选）
5. ✅ 配置雷达参数（Setup, Work, 边界）
6. ✅ 点击Write写入设备

### 场景3：直接使用工具
1. ✅ 点击 📏 Line（不点家具）
2. ✅ 在Canvas画线
3. ✅ 完成后为"Other"类型，灰色
4. ✅ 后期可点击Wall改为墙体（变黑色）

### 场景4：取消工具
1. ✅ 点击Bed激活（Bed和Rectangle高亮）
2. ✅ 再次点击Bed
3. ✅ 确认两个按钮都取消激活
4. ✅ Canvas回到选择模式

---

## 📊 状态机 ✅ 正确流程

```
初始状态
   │
   ├─► 点击家具类型 ──► 自动激活工具 ──► 绘图模式 ──► 完成绘制
   │      (Bed)           (Rectangle)                      │
   │                                                        ▼
   │                                              自动设置类型+颜色
   │                                                        │
   │                                                        ▼
   │                                                  对象选中
   │                                                        │
   ├─► 点击IoT设备 ──► 直接生成 ────────────────────────►│
   │     (Radar)                                            │
   │                                                        │
   ├─► 点击绘图工具 ──► 绘图模式 ──► 完成(Other类型) ──►│
   │     (Line)                                             │
   │                                                        │
   └─► 点击Canvas对象 ─────────────────────────────────►│
                                                            │
                                                            ▼
                                                      编辑属性
                                                            │
                                                            ├─► 修改几何
                                                            ├─► 修改颜色
                                                            ├─► Read/Write(IoT🟢)
                                                            └─► Save/Delete
```

---

## 🎯 核心要点总结

### ✅ 正确的操作逻辑（B方案修正版）

#### 家具/结构
```
1. 点击家具按钮（如Bed）
2. 绘图工具自动激活（Rectangle自动高亮）
3. 在Canvas上画图（尺寸由用户决定，只预设颜色）
4. 完成后自动设置类型和颜色
```

#### IoT设备
```
1. 点击设备按钮（如Radar）
2. 直接生成到Canvas（无需画图）
3. 可拖动调整位置
4. Read/Write按钮自动高亮🟢
```

#### 直接画图
```
1. 点击绘图工具（如Line）
2. 在Canvas上画图
3. 完成后为"Other"类型
4. 后期可改类型
```

### ❌ 错误的旧逻辑（已废弃）
```
❌ 先画图 → 再点家具 → 设置类型  (旧方案A，已废弃)
✅ 先选类型 → 自动激活工具 → 画图  (新方案B修正版)
```

### 🎨 尺寸管理原则
```
✅ 只预设颜色，不预设尺寸
✅ 尺寸由用户画图时自然决定
✅ 画完后可在属性面板微调
✅ 避免长宽混淆，更符合人类习惯
```

---

**版本**：v2.0  
**更新时间**：2025-10-29  
**状态**：✅ 逻辑已修正  
**配置**：只预设颜色，尺寸由用户决定


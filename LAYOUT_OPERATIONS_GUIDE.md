# Layout 操作指南

## 📌 关键概念

### Canvas 标识
- **Canvas ID**: 标准 UUID 格式（由服务器生成）
  - 示例: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- **Canvas Name**: 房间名称（用户友好）
  - 示例: `Room 101` 或 `ICU-A-01`

---

## 🔧 三种操作详解

### 1️⃣ LaySave - 保存到数据库

**功能**: 将当前 Canvas 布局保存到 PostgreSQL 数据库

**操作步骤**:
1. 在 Canvas 上编辑布局（添加家具、设备等）
2. 点击 Toolbar 上的 **"LaySave"** 按钮
3. 等待保存确认（会显示版本号）

**后台流程**:
```
Canvas 编辑
    ↓
点击 LaySave
    ↓
POST /api/canvas/save
    ↓
PostgreSQL 保存
    ↓
localStorage 缓存
    ↓
返回版本号
```

**适用场景**:
- ✅ 日常保存
- ✅ 跨设备访问
- ✅ 多人协作（刷新页面即可看到最新布局）

**注意事项**:
- 需要后端 API 支持
- 需要网络连接
- 自动缓存到 localStorage（离线时可用）

---

### 2️⃣ LayExp - 导出到本地文件

**功能**: 将当前 Canvas 布局导出为 JSON 文件，下载到本地

**操作步骤**:
1. 点击 Toolbar 上的 **"LayExp"** 按钮
2. 浏览器自动下载 JSON 文件
3. 文件保存到默认下载目录

**文件命名规则**:
```
canvas_Room_101_1730123456789.json
       ↑        ↑
   Canvas名称  时间戳
```

**文件内容**:
```json
{
  "canvasId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "canvasName": "Room 101",
  "params": {
    "devices": [...]
  },
  "objects": [
    {
      "id": "obj_xxx",
      "name": "Bed",
      "geometry": {...},
      "device": {...}
    }
  ],
  "timestamp": "2025-11-02T10:30:00Z"
}
```

**适用场景**:
- ✅ 备份布局
- ✅ 迁移到另一个系统
- ✅ 版本管理（手动保存历史版本）
- ✅ 分享给其他用户

**注意事项**:
- 无需后端 API（纯前端操作）
- 无需网络连接
- 包含所有对象和设备配置

---

### 3️⃣ LayImp - 从本地文件导入

**功能**: 从本地 JSON 文件导入布局，恢复到 Canvas

**操作步骤**:
1. 点击 Toolbar 上的 **"LayImp"** 按钮
2. 选择之前导出的 JSON 文件
3. 确认导入（会覆盖当前内容）
4. Canvas 自动更新

**导入流程**:
```
点击 LayImp
    ↓
选择 JSON 文件
    ↓
解析文件内容
    ↓
覆盖当前 Canvas
    ↓
重新计算区域
    ↓
更新显示
```

**适用场景**:
- ✅ 恢复备份
- ✅ 从其他系统迁移
- ✅ 回滚到历史版本
- ✅ 导入其他用户的布局

**注意事项**:
- ⚠️ **会覆盖当前 Canvas 内容**（建议先 LayExp 备份）
- 无需后端 API（纯前端操作）
- 无需网络连接
- 导入后自动触发雷达区域重新计算

---

## 🔄 典型使用场景

### 场景 1: 日常编辑和保存

```
1. 护士 A 在 PC1 编辑布局
2. 点击 LaySave 保存到数据库
3. 护士 B 在 PC2 刷新页面
4. 自动加载最新布局
```

### 场景 2: 布局备份

```
1. 编辑完成后，点击 LayExp
2. 下载 canvas_Room_101_1730123456789.json
3. 保存到网盘或 U 盘
4. 作为历史版本保留
```

### 场景 3: 布局恢复

```
1. 误操作删除了所有家具
2. 点击 LayImp
3. 选择之前备份的 JSON 文件
4. 布局立即恢复
```

### 场景 4: 布局模板

```
1. 在 Room 101 创建标准布局
2. 点击 LayExp 导出为模板
3. 在 Room 102 点击 LayImp
4. 导入模板，稍作调整
5. 点击 LaySave 保存
```

---

## 🚨 重要提示

### ⚠️ 数据丢失风险

1. **LayImp 会覆盖当前内容**
   - 导入前务必确认
   - 建议先 LayExp 备份当前状态

2. **localStorage 缓存有限**
   - 浏览器清除缓存会丢失
   - 重要布局必须 LaySave 到数据库

3. **JSON 文件格式**
   - 不要手动修改 JSON 文件（除非你知道自己在做什么）
   - 格式错误会导致导入失败

### ✅ 最佳实践

1. **定期保存**: 编辑完成后立即 LaySave
2. **定期备份**: 每周 LayExp 一次，保存到安全位置
3. **版本命名**: LayExp 后手动重命名文件，添加版本说明
   - 例如: `canvas_Room_101_初始布局_2025-11-02.json`
4. **测试导入**: 导入后检查所有对象是否正常

---

## 🛠️ 故障排查

### 问题 1: LaySave 失败

**症状**: 点击 LaySave 后提示"保存失败"

**原因**:
- 后端 API 未启动
- 网络连接中断
- Canvas ID 格式错误（不是 UUID）

**解决**:
1. 检查后端是否运行：`curl http://localhost:3000/api/canvas/load/test-uuid`
2. 检查浏览器控制台错误信息
3. 临时使用 LayExp 导出，避免数据丢失

### 问题 2: LayExp 文件为空

**症状**: 导出的 JSON 文件打开后是空的

**原因**:
- Canvas 上没有任何对象
- 浏览器下载被拦截

**解决**:
1. 确认 Canvas 上有对象
2. 检查浏览器下载设置
3. 查看浏览器控制台是否有错误

### 问题 3: LayImp 导入失败

**症状**: 选择文件后提示"导入失败：文件格式错误"

**原因**:
- JSON 文件格式损坏
- 不是有效的 Canvas 布局文件
- 文件是旧版本格式

**解决**:
1. 用文本编辑器打开 JSON，检查格式
2. 确认文件包含 `canvasId`、`objects` 等字段
3. 尝试其他备份文件

---

## 📞 技术支持

如有问题，请提供：
1. 操作步骤（LaySave/LayExp/LayImp）
2. 错误提示（截图或文字）
3. 浏览器控制台日志
4. Canvas ID 和 Canvas Name

**日志查看**:
- 打开浏览器开发者工具（F12）
- 切换到 Console 标签
- 查找以下前缀的日志：
  - `💾` - 保存相关
  - `📤` - 导出相关
  - `📥` - 导入相关
  - `❌` - 错误信息





